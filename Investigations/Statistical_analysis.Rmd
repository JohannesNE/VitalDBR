---
title: "Statistical Analysis"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
    math: katex
---
```{r, message=FALSE}
#From CRAN
library(vcd)
library(MASS)
library(rcompanion)
library(jtools)
library(rlang)
library(broom.mixed)
library(pscl)
library(cplm)
library(tweedie)
library(performance)
library("tidyverse")

# It is a bit cumbersome to install  "rethinking" but here is what you need:
#-----------------------
# devtools::install_github("stan-dev/cmdstanr")
# install.packages(c("coda","mvtnorm","devtools","loo","dagitty"))
# devtools::install_github("rmcelreath/rethinking")
# install_cmdstan() 
#------------------------
library(rethinking)
```


First we import the data created by the algorithm above, but we exclude the parameters we don't need, like index, caseid, death in hospital, anasthesia start and end. 
```{r}
data <- read.csv("../Investigationsdf_win_full.csv")
cases <- VitalDBR::load_VDB("https://api.vitaldb.net/cases")
cases <- cases %>% select('caseid', 'aneend', 'anestart', 'preop_htn', 'preop_dm', 'preop_ecg', 'preop_pft', 'preop_cr', 'preop_alt')

merged <- merge(x=data,y=cases,by="caseid")
merged$knife_time <- (merged$opend - merged$opstart) / 3600
#merged$anediff <- ((merged$aneend - merged$anestart) - merged$knife_time) / 3600

data <- merged %>% select(-'X', -'aneend', -'anestart', -'opend', -'opstart') %>% filter(preop_ecg == "Normal Sinus Rhythm")
data <- mutate_if(data, is.character, as.factor) %>% select(-'caseid', -'death_inhosp', -'preop_ecg')
data$sex <- ifelse(data$sex=='M', 1,0)
data$preop_pft <- ifelse(data$preop_pft=='Normal',1, 0)
#data$anediff <- round(data$anediff, 4)
data$knife_time <- round(data$knife_time, 4)
data$ppv_under5 <- round(data$ppv_under5, 4)
data$ppv_over8 <- round(data$ppv_over8, 4)
data$age <- as.integer(data$age)
data <- na.omit(data)
# knife_time (opend - opstart)
#anediff <- (aneend - anestart)-knife_time
# optype 
# Komorbiditet: 
# preop_htn, preop_dm,preop_arrhythmia, preop_pft (sundhed før operation)
# preop_cr (nyrer),  
# preop_ast, preop_alt (lever) #kun en af dem da det er meget korrelerede
# summen af colloider og crystalloider (hvor meget iv væske) meget væske vil gøre ppv lav og det er associeret med et dårligt outcome
icu <- data$icu_days
head(data)
```
## Linear Regression
First of all we want to set a baseline for our future models, we do this with a linear regression:

```{r}
summary(linear_model <- glm(icu_days ~ . , data=data,family="gaussian"), link="identity")
```


(Forklar coefficienter)

```{r}
r = linear_model$residuals
qqnorm(r,ylab="Residuals")
qqline(r)
```
We can see that both ends of our qqplot is behaving unexpectedly, this indicates that the errors are not normally distributed.

Let's inspect our dependent variable then.  We see that it doesn't follow a normal distribution:
```{r}
#table(data$icu_days)
hist(data$icu_days, breaks=82)
```

It seems to follow a sort of poisson distribution, which also makes intuitive sense due to the nature of time spent in the ICU. 
But taking a closer look, we see that there are way to many 0-observations for it to be a simple poisson distribution. 
```{r}
sum(data$icu_days==0)/sum(nrow(data))
```
We can actually see that over 60% of our observations are 0. 
We also see some extremly large values like 82, indicating a distribution with a heavy tail. These things together is probably the reason why our qqplot didn't look normal.

Furthermore, we can also observe that the mean is not equal to the variance:
```{r}
mean(icu)
var(icu)
```
This violates the properties of the poisson distribution, where $$E(X) = VAR(X) = \lambda, \ \ X \sim poisson(\lambda)$$
When the variance is larger than the mean, we are working with what is called an "over-dispersed" model, which further incentivises us to look into more advanced modelling


## GLM theory
Before we test for overdispersement, we need to understand GLM's
------- THEORY ---------

## Testing overdispersement and choosing model
```{r}
library(AER)
pois_reg <- glm(icu_days ~ ., data = data, family='poisson')
#summary(pois_reg)
dispersiontest(pois_reg,trafo=1) #Trafo ?? 
```
This shows strong evidence of overdispersement as the alpha should be close to 1 for it to not be overdispersed, this means that we should look at a quasi poisson distribution. 



## Quasi poisson
(VI FJERNER MÅSKE QUASI POISSON )

The quasi Poisson distribution is a normal poisson distribution, but with an added dispersement parameter.

---- Theory ------

```{r}
summary(q_pois_reg <- glm(icu_days ~ ., family=quasipoisson, data=data))
```


But what if our guess that is is a poisson is just wrong? We can also look at the negative binomial distribution. 
## Negative binomial distribution
The negative binomial distribution is similar to the quasi poisson, as it also has a dispersion parameter , 
BUT DIFFERENT BECAUSE: 
------ THEORY -----

```{r}
nbin_reg <- MASS::glm.nb(icu_days ~ . , data=data)
summary(nbin_reg)
```



(gode diagnostics til count data)
 - https://stats.stackexchange.com/questions/70558/diagnostic-plots-for-count-regression

- https://stats.oarc.ucla.edu/r/dae/poisson-regression/
- https://stats.stackexchange.com/questions/108995/interpreting-residual-and-null-deviance-in-glm-r
- https://www.datascienceblog.net/post/machine-learning/interpreting_generalized_linear_models/
- https://www.dataquest.io/blog/tutorial-poisson-regression-in-r/

## Comparing models.


We can only use the residual deviance to compare to other models:

----- THEORY ABOUT DEVIANCE ------


But looking at the residual deviance:
```{r}
# make a nice table here
linear_model$deviance
pois_reg$deviance
q_pois_reg$deviance
nbin_reg$deviance

```
We can clearly see that the negative binomial distribution is the best fit for our data so far. 


We can also plot the estimates and standard deviations for each parameter in the models
```{r}
jtools::plot_summs(linear_model, pois_reg, q_pois_reg,nbin_reg)
```

------ FORTOLKES --------
Hvorfor er poisson og quasi poison så ens????


## Zero Inflated models
But what if our problem is not overdispersion, but actually zero inflation?

Looking at the zero-inflated Poisson distribution, we can see that this model is comprised of two different processes. The first of which generates zeros:
$$\operatorname{Pr}(Y=0)=\pi+(1-\pi) e^{-\lambda}$$
Which is a binomial GLM, that predicts the odds of seeing an event given a vector of regression variables. Essentially a logistic regression, as it predicts a "probability" between 0 and 1 of observing 0. 

The second is a poisson distribution 
$$\operatorname{Pr}\left(Y=y_{i}\right)=(1-\pi) \frac{\lambda^{y_{i}} e^{-\lambda}}{y_{i} !}, \quad y_{i}=1,2,3, \ldots$$
The $\pi$ present in both models are the mixing coefficient determining how much emphasis we give to each model


https://stats.stackexchange.com/questions/469035/zero-inflated-model-in-r-building-the-model-with-pscl-not-understanding-use-of

https://en.wikipedia.org/wiki/Zero-inflated_model
https://stats.stackexchange.com/questions/368913/zero-inflated-count-data-simulation-in-r)


When using a zero-inflated model we can either write the model as:

```{r}
zeroinfl(icu_days ~ .| . , data=data, dist="poisson")
```

If we believe the zero-variables are also dependent on the other variables.

Or we can write the model like this:

```{r}
summary(zi_pois_reg <-pscl::zeroinfl(icu_days ~ .| emop , data=data, dist="poisson"))
```
If we think that only a specifik set of variables influences the zero inflation. In this case we believe that emergency operations influence whether people are designated to spent 0 days in the ICU.
We will use the latter, as there will be patients undergoing operations, that are "non-intrusive", meaning that they will almost never spent any days in the ICU.
SKAL LIGE SKRIVE BEDRE



(Bliv sikker på at man sætter modellen op som ovenover)


------- FORTOLKNING ---------


Now let us compare this model to the normal poisson regression, we do that with a Vuong closeness statistic. The statistic tests the null hypothesis that the two models are equally close to the true data generating process, against the alternative that one model is closer. Note that it cannot make any decision whether the "closer" model is the true model. 
```{r}
pscl::vuong(pois_reg, zi_pois_reg)
```
We can see that the Vuong z-statistic is significant, which means that model 2 (zeroinflated) is better than model 1 (regular)
The vuong test is very CONTROVERSIAL
------ THEORY -------

https://stats.oarc.ucla.edu/r/dae/zip/

# Zero inflated negative binomial
But actually we might be suffering from both zero-inflation AND overdispersement in the non zero observations? This calls for the zero inflated negative binomial model. This model accounts for zero-inflation, but it also has a shape better suited for overdispersed data due to the overdispersement parameter mentioned eralier.

```{r}
zi_nbin_reg <- zeroinfl(icu_days ~ .| emop , data=data, dist="negbin")
summary(zi_nbin_reg)
```

------ FORTOLK -------


Again we can look at the vuong test for zero inflated models:
```{r}
pscl::vuong(nbin_reg, zi_nbin_reg)
```
IGEN DEN ER MEGET KONTROVERSIEL, SKAL MÅSKE BARE FJERNES
----- FORTOLK ------


# Comparing zero inflated models
```{r}
library(lmtest)
lrtest(zi_pois_reg, zi_nbin_reg )
```
The test shows that the second model (zero inflated negative binomial) is the best, on all levels of significance¨
----- Foklar udskrift -----


# Compound poisson regression
Now we will explore "compound poisson regression" as an even more advanced way of modelling our data. This distribution is useful in situations with a very large proportion of zero observations. It is commonly used in rainfall modelling , where there are many more days per year without rain than days with rain (Probably not that useful in Denmark...). It is also often used in actuarial math, especially when modelling premiums, as most people in a given year do not get any payments from their insurance, but a few people get a lot of money paid out. 

Our compound distribution, often referred to as the "Compound Poisson-Gamma distribution" is defined as: 
$$  Y = \sum_i^T X_i$$
Where
$$ T \sim Pois(\lambda), X_{i} \stackrel{\mathrm{iid}}{\sim} \operatorname{Gamma}(\alpha, \gamma), \ \ T \perp X_{i}$$
Where $\perp$ means independence between two random variables.

To clarify, the amount of gamma distributions, depends in itself on the poisson distribution. When the poisson distribution, T, comes out to zero, then there are no gamma distributions in the sum above. 

This is also the reason why this distribution is so powerful! When $T=0$ then $Y=0$, which allows the distribution to have a defined probability mass function at it's origin, 0. This is in contrast with the zero inflated model, where p(X=0) is not clearly defined

This means that we can model our dependent variable as:
$$ Y \sim CPois(\mu_i, \phi, \rho)$$
Where the parameters are defined as so:

- $\mu = E(Y)$ is the mean, and is equal to the design matrix and the regression coefficients through a link function $\eta$ as so: $\eta (\mu) = X \beta$. The link function is set to logarithmic. 

- $\phi$  is the dispersion parameter which, crudely said, indicates whether the distribution is wide or narrow

- $\rho$ is the "index parameter" and indicates which distribution from the Tweedie family we are looking at. As indicated here: https://en.wikipedia.org/wiki/Tweedie_distribution under "related distributions", the index parameter should lie in $1 < \rho < 2$, if we are working with a compound poisson-gamma distribution.


https://www.r-bloggers.com/2014/10/a-note-on-tweedie/
https://cran.r-project.org/web/packages/cplm/vignettes/cplm.pdf

We can do a compound poisson regression using the library "CPLM" 
```{r}
c_pois_reg <- cplm::cpglm(icu_days ~ . , data = data, link = "log")
summary(c_pois_reg)
```

(Indsæt analyse af coefficienter)

# Comparing all models


## Akaika information criteria
------ TEORI OM AIC -------

```{r}
library(bbmle)
models <- list(linear_model, pois_reg, q_pois_reg, nbin_reg,zi_pois_reg,zi_nbin_reg,c_pois_reg)
aic_models <- sapply(models, AIC)
metrics <- list("AIC")
dfun <- function(object) {
with(object,sum((weights * residuals^2)[weights > 0])/df.residual)
}
quasi_aic <- qAIC(pois_reg,dispersion=dfun(pois_reg)) # Her burger vi den alm  poisson model, men giver den dispersion parametret
model_names <- list('linear_model', 'pois_reg', 'q_pois_reg', 'nbin_reg','zi_pois_reg','zi_nbin_reg','c_pois_reg')
data <- data.frame(matrix(ncol=length(model_names), nrow = 1))
colnames(data) <- model_names
rownames(data) <- metrics
data[1,] <- aic_models
data[1,"q_pois_reg"] <- quasi_aic # indsæt rigtig værdi

#data[3,] <- deviance_models
data
```




## Graphical overview of density functions
If we would like a graphical view of how the distributions overlay the histogram, then the regular poisson and the compound poisson is trivial. But for the zero inflated model, there exists no parametric way to define the density function on a given dataset as the function is not defined at 0.  (NEEDS CITATION). 
Therefore to get an idea of what the density could look like in a zero-inflated model we can use the package "rethinking" (from the famous bayesian book "Statiscical Rethinking" by Richard Mc Elreath) to plot the distribution given the probability of observing 0 and the mean of the distribution.

```{r}


mu  <- mean(icu)
xi = c_pois_reg$p
phi = c_pois_reg$phi
hist(icu, breaks=83, freq = FALSE)
x <- seq(0, 82)
lines(x, tweedie::dtweedie(x, xi, mu, phi), col="red", type='l') # Compound

lines(dpois(x=x,lambda=mu),type="l", col="blue") # Normal poisson

dispersion <- nbin_reg$theta
lines(dnbinom(x, size = dispersion, mu = mu ),type="l", col="orange") # Negative binomial

p = sum(data$icu_days==0)/sum(nrow(data))
lines(rethinking::dzipois(x, p = p , lambda = mean(icu)),type="l", col="green") # Zero Inflated poisson


lines(countreg::dzinbinom(x=x, mu=mu, theta = zi_nbin_reg$theta, pi= p), type="l", col="darkorchid1") # Zero Inflated negative binomial
# er ikke sikker på mu parameteren i den sidste

```

https://stackoverflow.com/questions/21807118/r-codes-for-tweedie-compound-poisson-gamma

Vi kan også sammenligne "Deviance" men ikke for de zero inflated models, da deviance er en GLM ting

```{r}
c_pois_reg$deviance
linear_model$deviance
pois_reg$deviance
nbin_reg$deviance
```
Vi kunne også køre test/validation set opdeling? 

## Discussion of confounders


## TO DO:
- Forklare coefficienter
- forklaring af residual deviance vs null deviance (se stack link)
- vigtigt at vi konkluderer på om det rent faktisk blir bedre
- analyser ALLE coefficenter med exp(coef(model)) https://rpubs.com/kaz_yos/pscl-2
- Vi skal finde en måde at sammenligne de mere komplicerede modeller
