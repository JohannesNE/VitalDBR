---
title: "filter_load"
author: "Georg"
date: "5/11/2022"
output: html_document
---

```{r}
library(devtools)
install_github('legendenomgeorg/VitalDBR/VitalDBR')
library(VitalDBR)
library("tidyverse")
library(readr)
library(mgcv)
```
Det er åbenbart meget udfordrende at lave en funktion der kan tage en liste af argumenter, og så passe dem ind i filter funktionen, så det blir bare lige sådan her fremadrettet. Det hører nok også under basic r
```{r}
cases <- VitalDBR::load_VDB("https://api.vitaldb.net/cases") %>%
      dplyr::filter(approach=="Open",
                department=="General surgery",
                ane_type=="General") %>%
      dplyr::select(caseid, death_inhosp, icu_days, age, sex, asa, emop, bmi, opstart, opend)
cases
```

Har fjernet den dårlige version
# better version


Nå 3 min efter gik jeg havde sagt tak for i aften gik det op for mig at jeg kunne have gjort det meget mere simpelt. 
- Find alle caseid's der lever op til de der conditions ligesom ovenfor
- importer tracks med VitalDBR::load_VDB("https://api.vitaldb.net/cases")
- Find alle caseid's der har både Primus/AWP og SNUADC/ART. Og join de to tables. Så har man alle de case id'er vi skal finde
```{r}
tracks <- VitalDBR::load_VDB("https://api.vitaldb.net/trks") %>%
    dplyr::filter(tname == "Primus/AWP" | tname == "SNUADC/ART") %>%
    count(caseid) %>%
    dplyr::filter(n == 2)


```

```{r}
merged <- merge(x=tracks,y=cases,by="caseid") %>% dplyr::select(-one_of("n"))
#merged %>% dplyr::filter(death_inhosp==1)
#merged %>% dplyr::filter(icu_days>10)
```


```{r}
merged
```


```{r}

calc_PPV <- function(smooth, intercept) {
min_PP <- min(smooth)
max_PP <- max(smooth)
(max_PP - min_PP) / unname(intercept)
}

ppv_prepare <- function(case, data_art, data_awp){
  # det tager usandsynligt lang tid, så vi skal have fixet den load funktion....
  # men ellers er det bare at implemetere PPV udregningen her
  start = 10000
  sec = 30
  
  sub_awp <- VitalDBR::subset_data(data = data_awp, seconds = sec, start_sec = start)
  insp_start <- VitalDBR::get_inspiration_start(sub_awp)
  sub_art <- VitalDBR::subset_data(data = data_art, seconds = sec, start_sec = start, filter=TRUE, cut_freq = 25)
  sub_art=na.omit(sub_art)
  sub_awp=na.omit(sub_awp)
  beats <- waveformtools::find_abp_beats(sub_art,abp_col=3,time_col=1)[-1,]
  beats_indexed <- waveformtools::add_time_since_event(beats, time_event = insp_start$time)
  PP_data <- beats_indexed[,c("PP","time","ann_rel_index")]
  PP_gam <- gam(
  PP ~ 
  s(ann_rel_index,k =15, bs = "cc" ) + s(time, bs = "cr"), # splines
  knots = list(ann_rel_index = c(0,1)), method = "REML", data = PP_data )
  splines <- predict(PP_gam, type = "terms")
  PPV <- calc_PPV(splines[,1], intercept = coef(PP_gam)[1])*100
  return(PPV)
}

process_cases <- function(data){
  ppv_list <- data.frame(matrix(ncol=1,nrow=0))
  
  for (caseid in data$caseid){
    startTime <- Sys.time()
    art <- VitalDBR::load_case('SNUADC/ART', caseid)
    awp <- VitalDBR::load_case('Primus/AWP', caseid)
    endTime <- Sys.time()
    print(endTime - startTime)
    ppv_list <- rbind(ppv_list, ppv_prepare(caseid,art,awp))
  }
  colnames(ppv_list) <- c('PPV')
  return(cbind(data,ppv_list))
}

startTime <- Sys.time()
ppv_data <- process_cases(merged[3,])
endTime <- Sys.time()
print(endTime - startTime)
ppv_data
```


```{r}
(((1359/2)*29)/60)/60
9.373362/10.97918
```


```{r}
path <- getwd()
filename = paste(path, 'df.csv',sep = '')
write.csv(ppv_data, filename)
```

```{r}
VitalDBR::load_VDB("https://api.vitaldb.net/cases")
```



```{r}
data_art <- VitalDBR::load_case('SNUADC/ART', 16)
```


```{r}
plot(data_art,type='l')
start = 10000
sec= 30
sub_art <- VitalDBR::subset_data(data = data_art, seconds = sec, start_sec = start)
plot(sub_art,type='l')
```
```{r}
opstart <- 1668
opend <- 10369
op <- opend - opstart
iterations <- floor(op/60)
interval <- 60
data <- c(matrix(nrow=iterations))
for (i in 1:iterations){
  data[i] <- opstart+(interval*i)
}
data
```
```{r}
View(VitalDBR::load_VDB("https://api.vitaldb.net/cb3ec59a7777932470adcb1e1a798c754d8ffab3.csv.gz"))
```

```{r}
VitalDBR::load_case('Primus/AWP', 16)
```

