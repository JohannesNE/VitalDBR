---
title: "filter_load"
author: "Georg"
date: "5/11/2022"
output: html_document
---

```{r}
library(devtools)
install_github('legendenomgeorg/VitalDBR/VitalDBR',force=TRUE)
library(VitalDBR)
library("tidyverse")
library(readr)
library(mgcv)
library("profvis")
```
Det er åbenbart meget udfordrende at lave en funktion der kan tage en liste af argumenter, og så passe dem ind i filter funktionen, så det blir bare lige sådan her fremadrettet. Det hører nok også under basic r
```{r}
cases <- VitalDBR::load_VDB("https://api.vitaldb.net/cases") %>%
      dplyr::filter(approach=="Open",
                department=="General surgery",
                ane_type=="General") %>%
      dplyr::select(caseid, death_inhosp, icu_days, age, sex, asa, emop, bmi, opstart, opend)
cases
```

Har fjernet den dårlige version
# better version


Nå 3 min efter gik jeg havde sagt tak for i aften gik det op for mig at jeg kunne have gjort det meget mere simpelt. 
- Find alle caseid's der lever op til de der conditions ligesom ovenfor
- importer tracks med VitalDBR::load_VDB("https://api.vitaldb.net/cases")
- Find alle caseid's der har både Primus/AWP og SNUADC/ART. Og join de to tables. Så har man alle de case id'er vi skal finde
```{r}
tracks <- VitalDBR::load_VDB("https://api.vitaldb.net/trks") %>%
    dplyr::filter(tname == "Primus/AWP" | tname == "SNUADC/ART") %>%
    count(caseid) %>%
    dplyr::filter(n == 2)


```

```{r}
merged <- merge(x=tracks,y=cases,by="caseid") %>% dplyr::select(-one_of("n"))
#merged %>% dplyr::filter(death_inhosp==1)
#merged %>% dplyr::filter(icu_days>10)
```


```{r}
merged
```


```{r}
profvis({
calc_PPV <- function(smooth, intercept) {
min_PP <- min(smooth)
max_PP <- max(smooth)
(max_PP - min_PP) / unname(intercept)
}

ppv_prepare <- function(case, start, end, data_art, data_awp){
  # det tager usandsynligt lang tid, så vi skal have fixet den load funktion....
  # men ellers er det bare at implemetere PPV udregningen her
  op <- end - start
  interval <- 120
  iterations <- floor(op/interval)
  data <- c(matrix(nrow=iterations))
  for (i in 1:iterations){
    sub_awp <- VitalDBR::subset_data(data = data_awp, seconds = interval, start_sec = start+(interval*i))
    sub_awp <- na.omit(sub_awp)
    insp_start <- VitalDBR::get_inspiration_start(sub_awp)
    sub_art <- VitalDBR::subset_data(data = data_art, seconds = interval, start_sec = start+(interval*i), filter=TRUE, cut_freq = 25)
    if (sum(is.na(sub_art$Time))>=nrow(sub_art)/2){
      # if the dataframe consists of over half na values we skip the iteration
      data[i] <- NA
      next
    }
    beats <- waveformtools::find_abp_beats(sub_art,abp_col=2,time_col=1)
    beats_indexed <- waveformtools::add_time_since_event(beats, time_event = insp_start$time)
    PP_data <- beats_indexed[,c("PP","time","ann_rel_index")]
    PP_gam <- gam(
    PP ~ 
    s(ann_rel_index,k = 5, bs = "cc" ) + s(time, k = 5, bs = "cr"), # splines
    knots = list(ann_rel_index = c(0,1)), method = "REML", data = PP_data )
    splines <- predict(PP_gam, type = "terms")
    data[i] <- calc_PPV(splines[,1], intercept = coef(PP_gam)[1])*100
    cat("Iteration",i, "out of ", iterations,". For case:",case)
  }
  
  return(data)
}

process_cases <- function(data){
  ppv_under6 <- data.frame(matrix(ncol=1,nrow=0))
  ppv_over12 <- data.frame(matrix(ncol=1,nrow=0))
  for (caseid in data$caseid){
    closeAllConnections()
    cat("Importing ART for case:",caseid)
    art <- VitalDBR::load_case('SNUADC/ART', caseid)
    cat("Importing AWP for case:",caseid)
    awp <- VitalDBR::load_case('Primus/AWP', caseid)
    start <- data$opstart[data$caseid==caseid] # This line and below could be optimized
    end <- data$opend[data$caseid==caseid] # - II -
    ppv_results <- na.omit(ppv_prepare(caseid, start, end, art,awp))
    len_ppv <- length(na.omit(ppv_results))
    ppv_under6 <- rbind(ppv_under6, sum(ppv_results<=6)/len_ppv)
    ppv_over12 <- rbind(ppv_over12, sum(ppv_results>=12)/len_ppv)
    
  }
  colnames(ppv_under6) <- c('ppv_under6')
  colnames(ppv_over12) <- c('ppv_over12')
  data <- cbind(data, ppv_under6)
  data <- cbind(data, ppv_over12)
  return(data)
}


startTime <- Sys.time()

ppv_data <- process_cases(merged[1:10,])

})
endTime <- Sys.time()
print(endTime - startTime)
ppv_data
```

```{r}
View(ppv_data)
```


```{r}
path <- getwd()
filename = paste(path, 'df.csv',sep = '')
write.csv(ppv_data, filename)
```



```{r}
opstart <- 1668
opend <- 10369
op <- opend - opstart
iterations <- floor(op/60)
interval <- 60
data <- c(matrix(nrow=iterations))
for (i in 1:iterations){
  data[i] <- opstart+(interval*i)
}
data
```


```{r}
data_art <- load_case("SNUADC/ART",12)
```


```{r}
interval <- 120
start <- 5360
end <- 30860
i <- 143
sub_art1 <- VitalDBR::subset_data(data = data_art, seconds = interval, start_sec = start+(interval*i))
tail(sub_art1,5)
```

```{r}
interval <- 120
start <- 5360
end <- 30860
i <- 160
sub_art2 <- VitalDBR::subset_data(data = data_art, seconds = interval, start_sec = start+(interval*i))

```


```{r}
sub_art2
plot(sub_art1)
plot(sub_art2)
```

```{r}
beats <- waveformtools::find_abp_beats(sub_art,abp_col=2,time_col=1)
beats
```
```{r}
318*130.59

```

