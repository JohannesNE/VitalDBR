---
title: "filter_load"
author: "Georg"
date: "5/11/2022"
output: html_document
---

```{r}
library(devtools)
install_github('legendenomgeorg/VitalDBR/VitalDBR')
library(VitalDBR)
library("tidyverse")
library(readr)
```
Det er åbenbart meget udfordrende at lave en funktion der kan tage en liste af argumenter, og så passe dem ind i filter funktionen, så det blir bare lige sådan her fremadrettet. Det hører nok også under basic r
```{r}
cases <- VitalDBR::load_VDB("https://api.vitaldb.net/cases") %>%
      dplyr::filter(approach=="Open",
                department=="General surgery",
                ane_type=="General") %>%
      dplyr::select(caseid, death_inhosp, icu_days, age, sex, asa, emop, bmi)
cases
```

```{r}

tmp <- VitalDBR::load_case("SNUADC/ART", 2258)
mean(tmp[,2])
```

```{r}
ppv <- function(case,art,awp){
  # her skal vi udregne ppv, men lige nu lægger jeg bare gennemsnittene sammen
  return(c(case, mean(na.omit(art[,2])) + mean(na.omit(awp[,2]) )))
  #return(c(case, 3))
}

try_load <- function(track,i) {
  data <-try(VitalDBR::load_case(track, i), TRUE)
if(isTRUE(class(data)=="try-error")) 
  {
  return(TRUE) 
  } 
else 
  { 
    return(data)
  } 
}

loop <- function(cases){
  data <- data.frame(matrix(ncol=2,nrow=0))
  for (case in cases){
    art <- try_load("SNUADC/ART", case)
    awp <- try_load("Primus/AWP", case)
    if (isTRUE(art) | isTRUE(awp)){
      return(NULL)
    }
    else{
      data <- rbind(data, ppv(case,art,awp))
    }
  }
  columns <- c("caseid", "PPV")
  colnames(data) <- columns
  return(data)
}


#loop(c(1,10))

```
Nå 3 min efter gik jeg havde sagt tak for i aften gik det op for mig at jeg kunne have gjort det meget mere simpelt. 
- Find alle caseid's der lever op til de der conditions ligesom ovenfor
- importer tracks med VitalDBR::load_VDB("https://api.vitaldb.net/cases")
- Find alle caseid's der har både Primus/AWP og SNUADC/ART. Og join de to tables. Så har man alle de case id'er vi skal finde
```{r}
tracks <- VitalDBR::load_VDB("https://api.vitaldb.net/trks") %>%
    dplyr::filter(tname == "Primus/AWP" | tname == "SNUADC/ART") %>%
    count(caseid) %>%
    dplyr::filter(n == 2)


```

```{r}
merged <- merge(x=tracks,y=cases,by="caseid") %>% dplyr::select(-one_of("n"))
merged %>% dplyr::filter(death_inhosp==1)
merged %>% dplyr::filter(icu_days>10)
```


```{r}
merged
```



Der sker et eller andet her
Error in readLines(con) : 
  cannot open the connection to 'https://api.vitaldb.net/.csv.gz' 



```{r}
load_case("Primus/AWP", 10)
```



```{r}
path <- getwd()
filename = paste(path, 'df.csv',sep = '')
write.csv(df, filename)
```



